{% block oro_ticker_symbol_widget %}
    <script type="text/javascript">
        $(function() {
            var cache = {};
            $("#{{ id }}").typeahead({
                source: function (request, process) {
                    YAHOO = {
                        Finance: {
                            SymbolSuggest: {
                                ssCallback: function (data) {
                                    var result = $.map(data.ResultSet.Result, function (item) {
                                        return item.name + " (" + item.symbol + ")";
                                    });
                                    $.each(data.ResultSet.Result, function (itemKey, item) {
                                        cache[item.name + " (" + item.symbol + ")"] = item.symbol;
                                    });
                                    process(result)
                                }
                            }
                        }
                    };
                    $.ajax({
                        type: "GET",
                        dataType: "jsonp",
                        jsonp: "callback",
                        jsonpCallback: "YAHOO.Finance.SymbolSuggest.ssCallback",
                        data: {
                            query: request
                        },
                        cache: true,
                        url: "http://autoc.finance.yahoo.com/autoc"
                    });
                },
                updater: function(item) {
                    if (typeof cache[item] != 'undefined') {
                        return cache[item];
                    } else {
                        return item;
                    }
                }
            });
        });
    </script>

    {{ form_widget(form) }}
{% endblock %}

{% block genemu_jqueryselect2_country_row %}
    {{ block('genemu_jqueryselect2_row') }}
{% endblock %}

{% block genemu_jqueryselect2_choice_row %}
    {{ block('genemu_jqueryselect2_row') }}
{% endblock %}

{% block genemu_jqueryselect2_entity_row %}
    {{ block('genemu_jqueryselect2_row') }}
{% endblock %}

{% block oro_jqueryselect2_hidden_row %}
    {{ block('genemu_jqueryselect2_row') }}
{% endblock %}

{% block genemu_jqueryselect2_row %}
    {{ form_row(form) }}
    {{ form_javascript(form) }}
{% endblock %}

{% block genemu_jqueryselect2_javascript %}
    <script type="text/javascript">
        (function() {
            var $field = $('#{{ id }}');

            {% block genemu_jqueryselect2_javascript_prototype %}
                var select2Config = {{ configs|json_encode|raw }};

                var getTitle = function (data, properties) {
                    if (!data) {
                        return '';
                    } else {
                        var result = [];
                        for (var i = 0; i < properties.length; i++) {
                            result.push(data[properties[i]]);
                        }
                        return result.join(' ');
                    }
                };

                var highlightSelection = function (str, selection) {
                    return str && selection ? str.replace(new RegExp(selection.term, 'ig'), '<b>$&</b>') : str;
                };

                var initSelection = function(element, callback) {
                    callback(element.data('entity'));
                };

                var formatResult = function (object, container, query) {
                    if (typeof select2Config.template != 'undefined') {
                        var tpl = _.template(select2Config.template);
                        return tpl(object);
                    } else if (typeof object._html != 'undefined') {
                        return object._html;
                    } else {
                        return highlightSelection(getTitle(object, select2Config.properties), query);
                    }
                };
                var formatSelection = formatResult;

                var ajax = null;
                if ($field.length && $field[0].tagName.toLowerCase() === 'input') {
                    {% set url = '' %}
                    {% if configs.ajax.url is defined %}
                        {% set url = configs.ajax.url %}
                    {% elseif configs.route is defined %}
                        {% set url = path(configs.route) %}
                    {% endif %}
                    ajax = {
                        'url': {{ url|json_encode|raw }},
                        'data': function (query, page) {
                            return {
                                'page': page,
                                'per_page': {{ configs.per_page|default(10) }},
                                'query': query
                            };
                        },
                        'results': function (data, page) {
                            return data;
                        }
                    };
                }

                {% if configs.datasource is defined %}
                    {{ block('oro_combobox_dataconfig_' ~ configs.datasource) }}
                {% endif %}

                if ($field.length && $field[0].tagName.toLowerCase() == 'input') {
                    if (ajax) {
                        select2Config.ajax = ajax;
                    }
                    select2Config.initSelection = initSelection;
                    select2Config.formatResult = formatResult;
                    select2Config.formatSelection = formatSelection;
                    select2Config.escapeMarkup = function(m) { return m; };
                }

                $field.select2(select2Config);
            {% endblock %}
        })();
    </script>
{% endblock %}

{% block oro_combobox_dataconfig_autocomplete %}
    if (ajax) {
        ajax.data = function (query, page) {
            return {
                'page': page,
                'per_page': {{ configs.per_page|default(10) }},
                'name': "{{ configs.autocomplete_alias }}",
                'query': query
            };
        };
    }
{% endblock %}

{% block oro_combobox_dataconfig_grid %}
    {% set url = configs.ajax.url is defined ? configs.ajax.url : path(configs.route, {'_format': 'json'}) %}
    ajax = {
        'url': {{ url|json_encode|raw }},
        'data': function (query, page) {
            return {
                '{{ configs.grid.name }}[_pager][_page]': page,
                '{{ configs.grid.name }}[_pager][_per_page]': {{ configs.per_page|default(10) }},
                '{{ configs.grid.name }}[_sort_by][{{ configs.grid.sort_by|default(configs.properties[0]) }}]': "{{ configs.grid.sort_order|default('ASC') }}",
                '{{ configs.grid.name }}[_filter][{{ configs.properties[0] }}][type]': 1,
                '{{ configs.grid.name }}[_filter][{{ configs.properties[0] }}][value]': query
            };
        },
        'results': function (data, page) {
            return {
                results: $.map(data.data, function(item) {
                    return {'id': item.id, 'text': item.{{- configs.properties[0] -}} };
                }),
                more: page*10 < data.options.totalRecords
            };
        }
    };
{% endblock %}

{% block oro_combobox_dataconfig_user %}
    formatResult = function(object, container, query) {
    var highlight = function(str) {
    return highlightSelection(str, query);
    };
    var avatar = object.avatar ? object.avatar : {{ asset('bundles/oroui/img/info-usser.png')|json_encode|raw }};
    return '<img src="' + avatar + '" width="16" height="16" /> '
    + highlight(object.firstName) + ' '
    + highlight(object.lastName)
    + ' - '+ highlight(object.email)
    + ' (' + highlight(object.username) + ')';
    };
    formatSelection = function(object, container, query) {
    var avatar = object.avatar ? object.avatar : {{ asset('bundles/oroui/img/info-usser.png')|json_encode|raw }};
    return '<img src="' + avatar + '" width="16" height="16" /> ' + object.firstName + ' ' + object.lastName;
    };
{% endblock %}
